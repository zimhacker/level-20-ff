<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  
  <style>
    /* Base Styles */
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --info: #4895ef;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --white: #ffffff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
    }

    /* Header Styles */
    .header {
      background-color: var(--white);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 15px 0;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    .header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-title {
      font-size: 1.25rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    /* Button Styles */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      background-color: transparent;
    }

    .btn:disabled {
      background-color: var(--gray);
      cursor: not-allowed;
      opacity: 0.7;
    }

    .btn-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
    }

    .btn-primary {
      background-color: var(--primary);
      color: var(--white);
    }

    .btn-primary:hover:not(:disabled) {
      background-color: var(--secondary);
    }
    
    .btn-success {
      background-color: var(--success);
      color: var(--white);
    }

    .btn-danger {
      background-color: var(--danger);
      color: var(--white);
    }

    .btn-block {
      width: 100%;
    }

    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      top: 70px;
      left: 0;
      bottom: 0;
      width: 250px;
      background-color: var(--white);
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      z-index: 900;
    }

    .sidebar.active {
      left: -250px;
    }

    .sidebar-menu {
      list-style: none;
      padding: 15px 0;
    }

    .sidebar-item {
      margin-bottom: 5px;
    }

    .sidebar-link {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: var(--gray);
      text-decoration: none;
      transition: all 0.3s ease;
      gap: 10px;
    }

    .sidebar-link:hover, .sidebar-link.active {
      background-color: rgba(67, 97, 238, 0.1);
      color: var(--primary);
    }

    .sidebar-link.active {
      font-weight: 500;
    }

    /* Main Content Styles */
    .main-content {
      margin-top: 70px;
      margin-left: 250px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .main-content.full-width {
      margin-left: 0;
    }

    /* Page Container Styles */
    .page-container {
      display: none; /* Hide all pages by default */
    }
    .page-container.active {
      display: block; /* Show only the active page */
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* Page Header (from dashboard.html) */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .page-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    /* Search Box (from dashboard.html) */
    .search-box {
      position: relative;
      display: flex;
      align-items: center;
    }
    .search-box i {
      position: absolute;
      left: 12px;
      color: var(--gray);
    }
    .search-box input {
      padding: 8px 15px 8px 35px;
      border: 1px solid #ddd;
      border-radius: 6px;
      width: 200px;
      transition: all 0.3s ease;
    }
    .search-box input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    /* Stats Grid (from index.html & dashboard.html) */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background-color: var(--white);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      position: relative;
      overflow: hidden;
    }

    .stat-card h3 {
      font-size: 1rem;
      color: var(--gray);
      margin-bottom: 10px;
    }

    .stat-card p {
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--dark);
    }

    .stat-icon {
      position: absolute;
      right: 20px;
      top: 20px;
      font-size: 2.5rem;
      opacity: 0.2;
      color: var(--dark);
    }

    /* Card Styles */
    .card {
      background-color: var(--white);
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      padding: 20px;
      margin-bottom: 20px;
    }

    .card h2 {
      font-size: 1.25rem;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    /* User List Styles (from index.html & dashboard.html) */
    .user-list {
      margin-top: 15px;
    }
    /* index.html grid style */
    #page-index .user-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }
    /* dashboard.html column style */
    #page-dashboard .user-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .user-card {
      background-color: var(--white);
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      border: 1px solid #eee;
    }

    .user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .user-header h3 {
      font-size: 1rem;
      font-weight: 600;
    }

    .user-status {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .user-status.active {
      background-color: rgba(76, 201, 240, 0.1);
      color: var(--success);
    }

    .user-status.inactive {
      background-color: rgba(247, 37, 133, 0.1);
      color: var(--danger);
    }

    .user-status i {
      font-size: 0.5rem;
    }

    .user-details {
      font-size: 0.85rem;
      color: var(--gray);
    }

    .user-detail {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .user-detail strong {
      color: var(--dark);
    }

    /* Form Styles (from admin.html & settings.html) */
    .form-group {
      margin-bottom: 20px;
    }

    .label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .form-control {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    #page-dashboard .form-control {
      padding: 8px 12px;
    }

    .form-control:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }
    
    .form-control:disabled {
      background-color: #f8f9fa;
      cursor: not-allowed;
    }

    /* Checkbox and Radio Styles (from admin.html) */
    .form-check {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-check-input {
      width: 18px;
      height: 18px;
    }

    .form-check-label {
      user-select: none;
    }

    .radio-group {
      display: flex;
      gap: 20px;
    }
    
    /* Form Check Toggle Switch (from settings.html) */
    .form-check.form-switch {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
    }
    .form-check.form-switch .form-check-input {
        appearance: none;
        width: 40px;
        height: 20px;
        background-color: #ddd;
        border-radius: 20px;
        position: relative;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .form-check.form-switch .form-check-input::before {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background-color: var(--white);
        top: 2px;
        left: 2px;
        transition: transform 0.3s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .form-check.form-switch .form-check-input:checked {
        background-color: var(--primary);
    }
    .form-check.form-switch .form-check-input:checked::before {
        transform: translateX(20px);
    }
    
    /* Toggle Switch (from dashboard.html) */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .toggle-slider {
      background-color: var(--success);
    }
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    .status-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Result Message (from admin.html & settings.html) */
    .form-result {
      margin-top: 15px;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
    }

    .form-result.success {
      background-color: rgba(76, 201, 240, 0.2);
      color: var(--success);
    }

    .form-result.error {
      background-color: rgba(247, 37, 133, 0.2);
      color: var(--danger);
    }

    /* Avatar Styles */
    .user-avatar img {
      object-fit: cover;
    }

    .rounded-circle {
      border-radius: 50%;
    }
    
    /* Loading State */
    .loading, .no-users, .error {
      padding: 20px;
      text-align: center;
      color: var(--gray);
    }

    /* Maintenance Mode Warning (from admin.html & dashboard.html) */
    .maintenance-warning {
      background-color: var(--warning);
      color: var(--dark);
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 500;
    }
    
    /* Maintenance Mode Overlay (from index.html) */
    .maintenance-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      text-align: center;
    }
    .maintenance-overlay h2 {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 20px;
    }
    .maintenance-overlay p {
      font-size: 1.1rem;
      color: var(--gray);
      max-width: 500px;
    }
    
    /* dashboard.html specific styles */
    #page-dashboard .user-details {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    .detail-group {
      margin-bottom: 10px;
    }
    .detail-group label {
      display: block;
      font-size: 0.85rem;
      color: var(--gray);
      margin-bottom: 5px;
    }
    .user-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }
    
    /* Alert (from dashboard.html) */
    .alert {
      position: fixed;
      top: 90px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 2100;
      animation: slideIn 0.3s ease forwards;
    }
    .alert-success {
      background-color: var(--success);
      color: var(--white);
    }
    .alert-error {
      background-color: var(--danger);
      color: var(--white);
    }
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    /* Date Picker Styles (from dashboard.html) */
    .date-picker-container {
      position: zim;
    }
    .date-picker-container .form-control {
      padding-right: 40px;
    }
    .date-picker-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
      cursor: pointer;
      z-index: 5;
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
      .sidebar {
        left: -250px;
      }
      .sidebar.active {
        left: 0;
      }
      .main-content {
        margin-left: 0;
      }
      
      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .page-actions {
        width: 100%;
        flex-direction: column;
        gap: 10px;
      }
      
      .search-box input {
        width: 100%;
      }
      
      #page-index .user-list {
        grid-template-columns: 1fr;
      }
      
      #page-dashboard .user-details {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <header class="header">
    <div class="container">
      <div class="header-left">
        <button class="btn btn-icon" id="sidebarToggle">
          <i class="fas fa-bars"></i>
        </button>
        <h1 class="header-title" id="pageHeaderTitle">
          <i class="fas fa-tachometer-alt"></i>
          <span>Admin Dashboard</span>
        </h1>
      </div>
      <div class="header-actions">
        <button class="btn btn-icon">
          <i class="fas fa-bell"></i>
        </button>
        <div class="user-avatar">
          <img src="logo.png" alt="Admin" width="40" height="40" class="rounded-circle">
        </div>
      </div>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <ul class="sidebar-menu">
      <li class="sidebar-item">
        <a href="#/index" class="sidebar-link active" data-page="index">
          <i class="fas fa-tachometer-alt"></i>
          <span>Dashboard</span>
        </a>
      </li>
      <li class="sidebar-item">
        <a href="#/admin" class="sidebar-link" data-page="admin">
          <i class="fas fa-user-plus"></i>
          <span>Add User</span>
        </a>
      </li>
      <li class="sidebar-item">
        <a href="#/dashboard" class="sidebar-link" data-page="dashboard">
          <i class="fas fa-users-cog"></i>
          <span>Manage Users</span>
        </a>
      </li>
      <li class="sidebar-item">
        <a href="#/settings" class="sidebar-link" data-page="settings">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </a>
      </li>
    </ul>
  </aside>

  <main class="main-content" id="mainContent">
    <div class="container">

      <div id="page-index" class="page-container">
        <h1 class="page-title">
          <i class="fas fa-tachometer-alt"></i>
          Dashboard Overview
        </h1>
        
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Total Users</h3>
            <p id="totalUsers">0</p>
            <i class="fas fa-users stat-icon"></i>
          </div>
          <div class="stat-card">
            <h3>Active Users</h3>
            <p id="activeUsers">0</p>
            <i class="fas fa-user-check stat-icon"></i>
          </div>
          <div class="stat-card">
            <h3>Inactive Users</h3>
            <p id="inactiveUsers">0</p>
            <i class="fas fa-user-slash stat-icon"></i>
          </div>
          <div class="stat-card">
            <h3>Today's Logins</h3>
            <p id="todayLogins">0</p>
            <i class="fas fa-sign-in-alt stat-icon"></i>
          </div>
        </div>

        <div class="card">
          <h2>User List</h2>
          <div id="userListIndex" class="user-list">
            <div class="loading">
              <i class="fas fa-spinner fa-spin"></i> Loading users...
            </div>
          </div>
        </div>
      </div>
      
      <div id="page-admin" class="page-container">
        <div id="maintenanceWarningAdmin" class="maintenance-warning" style="display: none;">
          <i class="fas fa-exclamation-triangle"></i> Site is currently in Maintenance Mode. User additions might be affected.
        </div>
        <div class="card">
          <form id="addUserForm">
            <div class="form-group">
              <label for="username" class="label">Username</label>
              <input type="text" id="username" class="form-control" placeholder="Enter username" required>
            </div>
            
            <div class="form-group">
              <label for="validity" class="label">Valid Until</label>
              <input type="datetime-local" id="validity" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label class="label">Status</label>
              <div class="form-check">
                <input type="checkbox" id="statusCheckbox" class="form-check-input">
                <label for="statusCheckbox" class="form-check-label">Active User</label>
              </div>
            </div>
            
            <div class="form-group">
              <label class="label">Device Access</label>
              <div class="radio-group">
                <div class="form-check">
                  <input type="radio" id="device1" name="access" value="1" class="form-check-input" checked>
                  <label for="device1" class="form-check-label">1 Device</label>
                </div>
                <div class="form-check">
                  <input type="radio" id="deviceUnlimited" name="access" value="∞" class="form-check-input">
                  <label for="deviceUnlimited" class="form-check-label">Unlimited Devices</label>
                </div>
              </div>
            </div>
            
            <button type="submit" id="addUserBtn" class="btn btn-primary btn-block">
              <i class="fas fa-user-plus"></i> Add User
            </button>
            
            <div id="result" class="form-result"></div>
          </form>
        </div>
      </div>
      
      <div id="page-dashboard" class="page-container">
        <div class="page-header">
          <h1 class="page-title">
            <i class="fas fa-users-cog"></i>
            User Management
          </h1>
          <div class="page-actions">
            <div class="search-box">
              <i class="fas fa-search"></i>
              <input type="text" id="searchInput" placeholder="Search users...">
            </div>
            <a href="#/admin" class="btn btn-primary" id="manageAddUserBtn">
              <i class="fas fa-user-plus"></i> Add User
            </a>
          </div>
        </div>

        <div id="maintenanceWarningDashboard" class="maintenance-warning" style="display: none;">
          <i class="fas fa-exclamation-triangle"></i> Site is currently in Maintenance Mode. User management might be restricted.
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <h3>Total Users</h3>
            <p id="totalUsersManage">0</p>
            <i class="fas fa-users stat-icon"></i>
          </div>
          <div class="stat-card">
            <h3>Active Users</h3>
            <p id="activeUsersManage">0</p>
            <i class="fas fa-user-check stat-icon"></i>
          </div>
          <div class="stat-card">
            <h3>Inactive Users</h3>
            <p id="inactiveUsersManage">0</p>
            <i class="fas fa-user-slash stat-icon"></i>
          </div>
        </div>

        <div class="card">
          <div id="userListManage" class="user-list">
            <div class="loading">
              <i class="fas fa-spinner fa-spin"></i> Loading users...
            </div>
          </div>
        </div>
      </div>
      
      <div id="page-settings" class="page-container">
        <h1 class="page-title">
          <i class="fas fa-cog"></i>
          General Settings
        </h1>
        
        <div class="card">
          <h2>Maintenance Mode</h2>
          <div class="form-group">
              <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="maintenanceModeToggle">
                  <label class="form-check-label" for="maintenanceModeToggle">Enable Maintenance Mode</label>
              </div>
              <div id="maintenanceResult" class="form-result"></div>
          </div>
        </div>

        <div class="card">
          <h2>App Settings</h2>
          <div class="form-group">
            <label for="versionInput" class="label">Version</label>
            <input type="text" id="versionInput" class="form-control" placeholder="Enter Version">
          </div>
          
          <div class="form-group">
            <label for="messageInput" class="label">Message</label>
            <input type="text" id="messageInput" class="form-control" placeholder="Enter Message">
          </div>
          
          <div class="form-group">
            <label for="linkInput" class="label">Link</label>
            <input type="text" id="linkInput" class="form-control" placeholder="Enter Link">
          </div>
          
          <button id="saveSettingsBtn" class="btn btn-primary save-btn">
            <i class="fas fa-save"></i> Save Settings
          </button>
          
          <div id="settingsResult" class="form-result"></div>
        </div>
      </div>

    </div>
  </main>
  
  <div id="maintenanceOverlay" class="maintenance-overlay" style="display: none;">
    <h2><i class="fas fa-tools"></i> Site Under Maintenance</h2>
    <p>We're currently performing some essential updates to improve your experience. We apologize for any inconvenience and appreciate your patience.</p>
    <p>Please check back shortly.</p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  
  <script type="module">
    // --- Firebase Imports ---
    import { db } from "./firebase-config.js";
    import { ref, onValue, update, get, set, remove } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    // --- Common DOM Elements ---
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const pageHeaderTitle = document.getElementById('pageHeaderTitle');
    const maintenanceOverlay = document.getElementById('maintenanceOverlay');
    const allPages = document.querySelectorAll('.page-container');
    const allSidebarLinks = document.querySelectorAll('.sidebar-link');
    
    // --- Global State ---
    let isMaintenance = false;
    let pageIndexLoaded = false;
    let pageAdminLoaded = false;
    let pageDashboardLoaded = false;
    let pageSettingsLoaded = false;

    // --- Common Logic: Sidebar Toggle ---
    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('active');
      mainContent.classList.toggle('full-width');
    });

    // --- Page: Index (Overview) ---
    function initIndexPage() {
      console.log("Initializing Index Page");
      const usersRef = ref(db, 'userinfo/');
      
      onValue(usersRef, (snapshot) => {
        const data = snapshot.val();
        let total = 0, active = 0, inactive = 0, todayLogins = 0;

        if (data) {
          Object.values(data).forEach(user => {
            total++;
            if (user.status === 'active') active++;
            else inactive++;
            // 'Today\'s Logins' logic would require login tracking
          });
          renderUserListIndex(data);
        } else {
          document.getElementById('userListIndex').innerHTML = '<div class="no-users">No users found</div>';
        }

        document.getElementById('totalUsers').textContent = total;
        document.getElementById('activeUsers').textContent = active;
        document.getElementById('inactiveUsers').textContent = inactive;
        document.getElementById('todayLogins').textContent = todayLogins;
      });
    }

    function renderUserListIndex(users) {
      const userListEl = document.getElementById('userListIndex');
      if (!users || Object.keys(users).length === 0) {
        userListEl.innerHTML = '<div class="no-users">No users found</div>';
        return;
      }
      userListEl.innerHTML = '';
      Object.entries(users).forEach(([username, user]) => {
        const userCard = document.createElement('div');
        userCard.className = 'user-card';
        userCard.innerHTML = `
          <div class="user-header">
            <h3>${username}</h3>
            <span class="user-status ${user.status}">
              <i class="fas fa-circle"></i> ${user.status}
            </span>
          </div>
          <div class="user-details">
            <div class="user-detail">
              <strong>Valid Until:</strong>
              <span>${user.validity || 'N/A'}</span>
            </div>
            <div class="user-detail">
              <strong>Access:</strong>
              <span>${user.access === '∞' ? 'Unlimited Devices' : '1 Device'}</span>
            </div>
            <div class="user-detail">
              <strong>Registered:</strong>
              <span>${user.rgtime || 'N/A'}</span>
            </div>
          </div>
        `;
        userListEl.appendChild(userCard);
      });
    }

    // --- Page: Admin (Add User) ---
    function initAdminPage() {
      console.log("Initializing Admin Page");
      const addUserForm = document.getElementById('addUserForm');
      const resultEl = document.getElementById('result');
      const maintenanceWarning = document.getElementById('maintenanceWarningAdmin');
      
      // Show warning if maintenance is on
      maintenanceWarning.style.display = isMaintenance ? 'block' : 'none';
      document.getElementById('addUserBtn').disabled = isMaintenance;

      function showResultAdmin(message, type) {
        resultEl.textContent = message;
        resultEl.className = `form-result ${type}`;
        setTimeout(() => {
          resultEl.textContent = '';
          resultEl.className = 'form-result';
        }, 3000);
      }

      addUserForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const username = document.getElementById('username').value.trim();
        const validity = document.getElementById('validity').value;
        const isActive = document.getElementById('statusCheckbox').checked;
        const access = document.querySelector('input[name="access"]:checked').value;
        const status = isActive ? 'active' : 'inactive';
        
        if (!username || !validity) {
          showResultAdmin('Please fill all fields', 'error');
          return;
        }

        const date = new Date(validity);
        const pad = n => n.toString().padStart(2, '0');
        const formattedDate = `${pad(date.getDate())}-${pad(date.getMonth() + 1)}-${date.getFullYear()} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
        const now = new Date();
        const rgtime = `${pad(now.getDate())}-${pad(now.getMonth() + 1)}-${now.getFullYear()} ${pad(now.getHours())}:${pad(now.getMinutes())}`;

        const userRef = ref(db, `userinfo/${username}`);
        set(userRef, {
          username, status, access, device: 'null',
          validity: formattedDate,
          rgtime: rgtime
        }).then(() => {
          showResultAdmin('User added successfully!', 'success');
          addUserForm.reset();
        }).catch((error) => {
          showResultAdmin('Error: ' + error.message, 'error');
        });
      });
    }

    // --- Page: Dashboard (Manage Users) ---
    function initDashboardPage() {
      console.log("Initializing Dashboard Page");
      const userListEl = document.getElementById('userListManage');
      const searchInput = document.getElementById('searchInput');
      const maintenanceWarning = document.getElementById('maintenanceWarningDashboard');
      const addUserButton = document.getElementById('manageAddUserBtn');
      let allUsers = {};
      let userActionsButtons = [];
      
      maintenanceWarning.style.display = isMaintenance ? 'block' : 'none';
      addUserButton.style.display = isMaintenance ? 'none' : 'inline-flex';

      function loadUsers() {
        const usersRef = ref(db, "userinfo");
        get(usersRef).then((snapshot) => {
          if (snapshot.exists()) {
            allUsers = snapshot.val();
            renderUsersManage(allUsers);
            updateStatsManage(allUsers);
          } else {
            userListEl.innerHTML = '<div class="no-users">No users found.</div>';
          }
        }).catch((error) => {
          userListEl.innerHTML = `<div class="error">Error loading users: ${error.message}</div>`;
        });
      }

      function renderUsersManage(users) {
        if (Object.keys(users).length === 0) {
          userListEl.innerHTML = '<div class="no-users">No users found.</div>';
          return;
        }

        userListEl.innerHTML = '';
        userActionsButtons = [];
        
        Object.entries(users).forEach(([username, user]) => {
          const userCard = document.createElement('div');
          userCard.className = 'user-card';
          userCard.innerHTML = `
            <div class="user-header">
              <h3>${username}</h3>
              <span class="user-status ${user.status}">
                <i class="fas fa-circle"></i> ${user.status}
              </span>
            </div>
            <div class="user-details">
              <div class="detail-group">
                <label>Status</label>
                <div class="status-control">
                  <label class="toggle-switch">
                    <input type="checkbox" id="status-${username}" ${user.status === 'active' ? 'checked' : ''}>
                    <span class="toggle-slider"></span>
                  </label>
                  <span id="status-text-${username}" class="status-text">
                    ${user.status === 'active' ? 'Active' : 'Inactive'}
                  </span>
                </div>
              </div>
              <div class="detail-group">
                <label>Valid Until</label>
                <div class="date-picker-container">
                  <input type="text" id="validity-${username}" value="${user.validity || ''}" class="form-control date-picker" placeholder="Select date and time">
                  <i class="fas fa-calendar-alt date-picker-icon"></i>
                </div>
              </div>
              <div class="detail-group">
                <label>Access</label>
                <select id="access-${username}" class="form-control">
                  <option value="1" ${user.access === '1' ? 'selected' : ''}>1 Device</option>
                  <option value="∞" ${user.access === '∞' ? 'selected' : ''}>Unlimited Devices</option>
                </select>
              </div>
              <div class="detail-group">
                <label>Registered</label>
                <input type="text" value="${user.rgtime || 'N/A'}" class="form-control" disabled>
              </div>
            </div>
            <div class="user-actions">
              <button class="btn btn-success" data-username="${username}" data-action="update">
                <i class="fas fa-save"></i> Update
              </button>
              <button class="btn btn-danger" data-username="${username}" data-action="delete">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          `;
          userListEl.appendChild(userCard);
          
          const toggleSwitch = document.getElementById(`status-${username}`);
          const statusText = document.getElementById(`status-text-${username}`);
          if (toggleSwitch && statusText) {
            toggleSwitch.addEventListener('change', function() {
              statusText.textContent = this.checked ? 'Active' : 'Inactive';
              statusText.style.color = this.checked ? 'var(--success)' : 'var(--danger)';
            });
            statusText.style.color = user.status === 'active' ? 'var(--success)' : 'var(--danger)';
          }
          
          const dateInput = document.getElementById(`validity-${username}`);
          if (dateInput) {
            const dateIcon = dateInput.nextElementSibling;
            const flatpickrInstance = flatpickr(dateInput, {
              enableTime: true, dateFormat: "d-m-Y H:i", time_24hr: true, minuteIncrement: 1, allowInput: true, clickOpens: true,
              onOpen: () => dateIcon.style.color = 'var(--primary)',
              onClose: () => dateIcon.style.color = 'var(--gray)'
            });
            dateIcon.addEventListener('click', () => flatpickrInstance.open());
          }
          
          const actionButtons = userCard.querySelectorAll('.user-actions button');
          actionButtons.forEach(btn => btn.disabled = isMaintenance);
          userActionsButtons.push(...actionButtons);
        });
        
        // Add single event listener for all buttons
        userListEl.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;
            
            const action = button.dataset.action;
            const username = button.dataset.username;
            
            if (action === 'update') updateUser(username);
            if (action === 'delete') deleteUser(username);
        });
      }

      function updateStatsManage(users) {
        let total = 0, active = 0, inactive = 0;
        Object.values(users).forEach(user => {
          total++;
          if (user.status === 'active') active++;
          else inactive++;
        });
        document.getElementById('totalUsersManage').textContent = total;
        document.getElementById('activeUsersManage').textContent = active;
        document.getElementById('inactiveUsersManage').textContent = inactive;
      }

      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const filteredUsers = {};
        Object.entries(allUsers).forEach(([username, user]) => {
          if (username.toLowerCase().includes(searchTerm)) {
            filteredUsers[username] = user;
          }
        });
        renderUsersManage(filteredUsers);
      });

      function updateUser(username) {
        if (isMaintenance) {
          showAlertDashboard('Cannot update user while in Maintenance Mode.', 'error');
          return;
        }
        const status = document.getElementById(`status-${username}`).checked ? 'active' : 'inactive';
        const validity = document.getElementById(`validity-${username}`).value;
        const access = document.getElementById(`access-${username}`).value;

        update(ref(db, `userinfo/${username}`), { status, validity, access })
          .then(() => {
            showAlertDashboard(`User ${username} updated successfully!`, 'success');
            allUsers[username] = { ...allUsers[username], status, validity, access };
            updateStatsManage(allUsers);
            
            const statusElement = document.querySelector(`#status-${username}`).closest('.user-card').querySelector('.user-status');
            statusElement.className = `user-status ${status}`;
            statusElement.innerHTML = `<i class="fas fa-circle"></i> ${status}`;
          })
          .catch((error) => showAlertDashboard('Error updating user: ' + error.message, 'error'));
      }

      function deleteUser(username) {
        if (isMaintenance) {
          showAlertDashboard('Cannot delete user while in Maintenance Mode.', 'error');
          return;
        }
        if (confirm(`Are you sure you want to delete ${username}? This action cannot be undone.`)) {
          remove(ref(db, `userinfo/${username}`))
            .then(() => {
              showAlertDashboard(`User ${username} deleted successfully!`, 'success');
              delete allUsers[username];
              renderUsersManage(allUsers);
              updateStatsManage(allUsers);
            })
            .catch((error) => showAlertDashboard('Error deleting user: ' + error.message, 'error'));
        }
      }

      function showAlertDashboard(message, type) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.innerHTML = `<span>${message}</span>`;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 3000);
      }
      
      loadUsers();
    }
    
    // --- Page: Settings ---
    function initSettingsPage() {
      console.log("Initializing Settings Page");
      const maintenanceModeToggle = document.getElementById('maintenanceModeToggle');
      const maintenanceResultEl = document.getElementById('maintenanceResult');
      const appupdateRef = ref(db, 'settings/appupdate');

      const versionInput = document.getElementById('versionInput');
      const messageInput = document.getElementById('messageInput');
      const linkInput = document.getElementById('linkInput');
      const saveSettingsBtn = document.getElementById('saveSettingsBtn');
      const settingsResultEl = document.getElementById('settingsResult');
      
      function showResultSettings(element, message, type) {
        element.textContent = message;
        element.className = `form-result ${type}`;
        setTimeout(() => {
          element.textContent = '';
          element.className = 'form-result';
        }, 3000);
      }

      onValue(appupdateRef, (snapshot) => {
        const settings = snapshot.val();
        if (settings) {
          maintenanceModeToggle.checked = settings.maintenanceMode === 'true';
          versionInput.value = settings.version || '';
          messageInput.value = settings.message || '';
          linkInput.value = settings.link || '';
        }
      });

      maintenanceModeToggle.addEventListener('change', () => {
        const maintenanceValue = maintenanceModeToggle.checked ? 'true' : 'false';
        update(appupdateRef, { maintenanceMode: maintenanceValue })
          .then(() => showResultSettings(maintenanceResultEl, `Maintenance mode ${maintenanceValue === 'true' ? 'enabled' : 'disabled'} successfully!`, 'success'))
          .catch((error) => showResultSettings(maintenanceResultEl, 'Error updating: '+error.message, 'error'));
      });

      saveSettingsBtn.addEventListener('click', () => {
        const settings = {
          version: versionInput.value.trim(),
          message: messageInput.value.trim(),
          link: linkInput.value.trim(),
          maintenanceMode: maintenanceModeToggle.checked ? 'true' : 'false'
        };
        update(appupdateRef, settings)
          .then(() => showResultSettings(settingsResultEl, 'Settings saved successfully!', 'success'))
          .catch((error) => showResultSettings(settingsResultEl, 'Error saving: ' + error.message, 'error'));
      });
    }

    // --- Global Maintenance Mode Listener ---
    const appupdateRef = ref(db, 'settings/appupdate');
    onValue(appupdateRef, (snapshot) => {
      const settings = snapshot.val();
      isMaintenance = settings && settings.maintenanceMode === 'true';
      
      // Re-run the router to apply maintenance rules
      router(); 
    });

    // --- Client-Side Router ---
    function router() {
      const hash = location.hash || '#/index';

      // 1. Handle Maintenance Mode
      if (isMaintenance && hash !== '#/settings') {
        maintenanceOverlay.style.display = 'flex';
        document.querySelector('.header').style.display = 'none';
        sidebar.style.display = 'none';
        mainContent.style.display = 'none';
        return; // Stop routing, show overlay
      } else {
        maintenanceOverlay.style.display = 'none';
        document.querySelector('.header').style.display = 'flex';
        sidebar.style.display = 'block';
        mainContent.style.display = 'block';
      }
      
      // 2. Hide all pages
      allPages.forEach(page => page.classList.remove('active'));
      
      // 3. Update active sidebar link
      let targetPage = 'index'; // default
      allSidebarLinks.forEach(link => {
        if (link.getAttribute('href') === hash) {
          link.classList.add('active');
          targetPage = link.dataset.page;
        } else {
          link.classList.remove('active');
        }
      });
      
      // 4. Show the target page and run its init function once
      switch(hash) {
        case '#/admin':
          document.getElementById('page-admin').classList.add('active');
          pageHeaderTitle.innerHTML = `<i class="fas fa-user-plus"></i> <span>Add New User</span>`;
          if (!pageAdminLoaded) {
            initAdminPage();
            pageAdminLoaded = true;
          }
          break;
          
        case '#/dashboard':
          document.getElementById('page-dashboard').classList.add('active');
          pageHeaderTitle.innerHTML = `<i class="fas fa-users-cog"></i> <span>User Management</span>`;
          if (!pageDashboardLoaded) {
            initDashboardPage();
            pageDashboardLoaded = true;
          }
          break;
          
        case '#/settings':
          document.getElementById('page-settings').classList.add('active');
          pageHeaderTitle.innerHTML = `<i class="fas fa-cog"></i> <span>Settings</span>`;
          if (!pageSettingsLoaded) {
            initSettingsPage();
            pageSettingsLoaded = true;
          }
          break;
          
        case '#/index':
        default:
          document.getElementById('page-index').classList.add('active');
          pageHeaderTitle.innerHTML = `<i class="fas fa-tachometer-alt"></i> <span>Admin Dashboard</span>`;
          if (!pageIndexLoaded) {
            initIndexPage();
            pageIndexLoaded = true;
          }
          break;
      }
    }

    // --- Initial Load and Listeners ---
    window.addEventListener('hashchange', router);
    window.addEventListener('load', router);

  </script>
</body>
</html>